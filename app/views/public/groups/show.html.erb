<div class="container my-5 px-sm-0">
  <div class="card mb-3 custom-card">
    <div class="card-body">
      <h2 class="custom-orange">🐰 <%= @group.name %></h2>
      <hr class="custom-hr">
      <p class="my-1 mt-3"><%= @group.description %><p>

      <!-- サムネイル画像 -->
      <%= link_to "#", data: { bs_toggle: "modal", bs_target: "#groupImageModal" } do %>
        <%= image_tag @group.image.variant(resize_to_limit: [200, 200]).processed, class: "img-fluid rounded my-2" %>
      <% end %>

      <!-- モーダル本体 -->
      <div class="modal fade" id="groupImageModal" tabindex="-1" aria-labelledby="groupImageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content bg-transparent border-0">
            <div class="modal-body text-center p-0">
              <%= image_tag @group.image, class: "img-fluid rounded" %>
            </div>
          </div>
        </div>
      </div>

      <p class="text-muted">作成者: <%= @group.owner.name %>さん</p>
      <% if user_signed_in? && @group.owner == current_user %>
        <%= link_to "編集", edit_group_path(@group), class: "btn btn-outline-primary" %>
        <%= link_to "削除", group_path(@group), method: :delete, data: { confirm: "本当に削除しますか？" }, class: "btn btn-outline-danger" %>
      <% end %>
    </div>
  </div>

  <%# 参加申請ボタン（オーナー自身と既に申請/承認済みの場合は表示しない） %>
  <% unless @group.owner_id == current_user.id || @group.group_members.exists?(user_id: current_user.id) %>
    <%= button_to "参加申請する", join_request_group_path(@group), method: :post, class: "btn bg-soft-orange btn-lg" %>
  <% end %>

  <%# オーナー向け：承認待ちリスト表示 %>
  <% if @group.owner_id == current_user.id %>
    <div class="mt-4">
      <hr class="custom-hr">
      <h4 class="mb-4 custom-orange">申請中のメンバー</h4>
      <% if @pending_members.any? %>
        <table class="table">
          <thead>
            <tr>
              <th>ユーザー名</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            <% @pending_members.each do |member| %>
              <tr>
                <td><%= member.user.name %>さん</td>
                <td>
                  <div class="d-flex gap-2">
                    <%= button_to "承認", approve_member_group_path(@group, member_id: member.id), method: :patch, class: "btn btn-success btn-sm" %>
                    <%= button_to "拒否", reject_member_group_path(@group, member_id: member.id), method: :patch, class: "btn btn-danger btn-sm" %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <p class="text-muted">現在申請中のユーザーはいません。</p>
      <% end %>
    </div>
  <% end %>
  <div class="mt-5">
    <hr class="custom-hr">
    <h4 class="mb-4 custom-orange">参加メンバー一覧</h4>
    <% if @group.members.any? %>
      <ul class="list-group">
        <% @group.members.each do |member| %>
          <li class="list-group-item"><%= member.name %>さん</li>
        <% end %>
      </ul>
    <% else %>
      <p class="text-muted">まだ参加メンバーはいません。</p>
    <% end %>
  </div>

  <hr class="custom-hr">
  <h4 class="mb-4 custom-orange">グループチャット</h4>
  <div class="card p-3 mb-3" style="height: 300px; overflow-y: auto;">
    <% @group.messages.order(created_at: :asc).each do |msg| %>
      <div class="mb-2">
        <strong><%= msg.user.name %>さん:</strong>
        <span><%= msg.content %></span>
        <small class="text-muted float-end"><%= msg.created_at.strftime("%H:%M") %></small>
      </div>
    <% end %>
  </div>

  <% if @group.group_members.approved.exists?(user_id: current_user.id) || @group.owner_id == current_user.id %>
    <%= form_with model: [@group, Message.new], local: true do |f| %>
      <div class="input-group">
        <%= f.text_field :content, class: "form-control", placeholder: "メッセージを入力..." %>
        <button class="btn bg-soft-orange ms-2">送信</button>
      </div>
    <% end %>
  <% else %>
    <p class="text-muted">※ グループ参加後にチャットが利用できます</p>
  <% end %>

</div>
